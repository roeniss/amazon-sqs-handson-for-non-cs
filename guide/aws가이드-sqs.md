# 비전공자를 위한 AWS 길라잡이

###### 2020 02 11 ~ 

###### AUSG 3기 오거나이저 문성혁



## 개요

EC2, IAM, SQS를 이용한 "배달의 민족 주문 대기열" 간접체험



## 진행방식

1. 배민 주문 시스템의 (물론 실제 서비스 현황과 매우 다름) 시나리오를 제시

2. Queue 시스템이 필요한 이유를 예시와 함께 제시

- ex1) 배민 주문의 경우 - DB는 동시에 여러가지 요청을 한 번에 처리하기 어려워한다. 먼저 큐에 주문 요청을 넣고 --> 실제 주문 접수는 **하나씩 차근차근** 진행
- ex2) 여행 패키지 상품을 주문할 때, 주문은 우선적으로 넣고 고객한테 잘 되었다고 알려준 후, 이후 큐에 신규 접수 요청을 넣고 --> (1) 담당 여행 가이드에게 안내 문자 발송 (2) 항공권 예매 진행 (이 경우 미리 비행기 좌석은 확보되었다는 전제) (3) 홈페이지 내용 갱신 (빈자리 -1) (4) 고객한테 메일 발송 등의 업무를 **순차적으로, 고객이 기다리지 않도록 나중에** 처리

3. AWS의 SQS 간단 소개
4. 시연 (아래 참조)

5. 종료



## 전체적인 가이드

### Step 1 - 사전준비

- IAM 세팅

1. 적절한 옵션으로 새 계정 추가
2. 별도 기록 유도



- EC2 세팅

1. ec2 콘솔 접속 && 적절한 옵션으로 인스턴스 추가 (서울 리전 체크)

   \* 보안그룹에서 현재 IP 22번 포트를 허용해 주지 않으면 아래 항목들을 진행하기 어려울 것입니다.

2. ec2 인스턴스 접속 with `WIndows10 + 파워셀(PowerShell)` or `Linux + Terminal`

3. `touch server_script.sh && nano server_script.sh`로 새로운 파일 생성

4. 미리 준비한 텍스트를 안에 복사해 넣기 (윈도우에선 우클릭으로 붙여넣기 작업 가능)

5. `source server_scripts.sh`로 해당 스크립트 실행 --> 자동으로 웹서버 준비 && 가동

6. 크롬 브라우저로 웹서버 주소에 접근해 잘 되는 것 확인



- SQS 세팅

1. sqs 콘솔 접속 (서울 리전 체크)

2. 적절한 옵션으로 새 FIFO 테이블 생성

   \* **이 대목에서 안내할 부분이 있습니다.** sqs 생성할 때 좌측의 일반 큐와 우측의 FIFO 큐 두 가지 옵션 중 하나를 고르는데 저희는 우측을 고릅니다. "우측은 철저하게 FIFO 원칙을 지키는 대신 속도가 많이 느리다. 하지만 주문 시스템에선 먼저 들어온 주문을 먼저 처리하는 것이 이상적이므로 (현실도 그럴지는 잘 모르겠습니다만) FIFO 큐를 채택한다", 고 설명하시면 되겠습니다.

### Step 2 - 시연

- 웹 서버에서 다음과 같은 항목들 진행

1. `1건의 주문 요청` 버튼 사용 & sqs 콘솔에서 확인
2. `1건의 주문 처리` 버튼 사용 & sqs 콘솔에서 확인
3. `10건의 주문 요청` 버튼 사용 & sqs 콘솔에서 확인
4. `10건의 주문 처리` 버튼 사용 & sqs 콘솔에서 확인
5. `50건의 주문 요청` 버튼 사용 & sqs 콘솔에서 확인
6. `50건의 주문 처리` 버튼 사용 & sqs 콘솔에서 확인
7. `무한 주문 요청` 버튼, `스페셜 주문 요청` 버튼, `무한 주문 처리` 버튼 사용 & 스페셜 주문이 정상적으로 처리되는 것까지 확인



### Step 3 - 뒷정리

*(위 항목은 당장 중요한 사안이 아니라고 판단하여 일단 스킵하였습니다)*

- SQS 삭제
- IAM 삭제
- EC2 삭제





## Disclaimer

- DynamoDB를 제거했기 때문에 위 사항은 6시간을 채우기엔 다소 부족한 느낌입니다. 그래도 일단은 미니멈으로 준비했으니 더 채울만한 부분이 있다면 말씀해주세요.



## 문제 발생 시 조치요령

- 잘 안될 때는 "전체 큐 삭제" 버튼을 사용하는 것이 첫 번째 조치
- 그래도 안된다면 sqs를 새로 생성
- 그래도 안된다면 서버를 새로 생성



- CASE **주문을 수락하는 과정에서 서버가 중지** : 가장 먼저 처리되어야 할 주문(즉, 남아있는 주문 중 제일 먼저 접수된 주문)이 잠시 동결상태에 걸릴 수 있습니다. 주문 처리 완료 대기 시간을 **10초**로 설정했으니, 전체 큐 삭제를 하거나 10초 후 재시도 하면 됩니다.

- CASE **큐에 입력된 데이터가 지속적으로 증가** : 터미널에서 `rs`를 입력하고 Enter를 누르면 서버가 재가동됩니다. (안될 경우 한 번 더 시도) 큐 데이터가 지속적으로 증가하는 것은 서버에서 처리되고 있는 작업이므로 서버를 재부팅하면 해결됩니다. 아래 사진 참고 부탁드립니다.

  ![image-20200214100521375](assets/image-20200214100521375.png)

  (`rs` 를 입력하자 서버가 재부팅 된 모습)

